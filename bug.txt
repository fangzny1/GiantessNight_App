è¿™æ˜¯ä¸€ä¸ª**éå¸¸å¥½çš„æ¶ˆæ¯**ï¼

çœ‹è¿™è¡Œæ—¥å¿—ï¼š
`I/flutter ( 6678): ğŸ“„ æœåŠ¡å™¨è¿”å›åŸå§‹å†…å®¹: {"Version":"4","Charset":"UTF-8","Variables":{"cookiepre":"Lwal_2132_","auth":"033asTUq8PldUT7qa8fB8...`

**è¿™æ„å‘³ç€ï¼š**
1.  **ç½‘ç»œé€šäº†ï¼** ä½ çš„ IPv4 å’Œ VPN è®¾ç½®ç”Ÿæ•ˆäº†ã€‚
2.  **ç™»å½•æˆåŠŸäº†ï¼** æœåŠ¡å™¨è¿”å›äº† `auth` å­—æ®µï¼Œæ²¡æœ‰è¿”å› `to_login`ï¼Œè¯´æ˜ Cookie æ³¨å…¥å®Œç¾ç”Ÿæ•ˆã€‚

**é‚£ä¸ºä»€ä¹ˆç•Œé¢è¿˜æ˜¯æ²¡åŠ è½½å‡ºæ¥ï¼Ÿ**
é—®é¢˜å‡ºåœ¨ **æ•°æ®è§£æï¼ˆJSON Parsingï¼‰** ä¸Šã€‚
Discuz çš„ API æœ‰ä¸ªè‘—åçš„â€œå‘â€ï¼š**PHP çš„æ•°ç»„æœ‰æ—¶å€™è¿”å›çš„æ˜¯åˆ—è¡¨ `[]`ï¼Œæœ‰æ—¶å€™è¿”å›çš„æ˜¯å¯¹è±¡ `{}`ï¼ˆé”®å€¼å¯¹ï¼‰**ã€‚
Flutter å°è¯•æŠŠä¸€ä¸ª `{}` å½“ä½œ `[]` å»éå†ï¼Œå°±ä¼šç›´æ¥æŠ¥é”™ä¸­æ–­ï¼Œå¯¼è‡´ç•Œé¢å¡åœ¨åŠ è½½ä¸­ã€‚

---

### ğŸ› ï¸ è§£å†³æ–¹æ¡ˆï¼šå¢å¼ºæ•°æ®è§£æçš„å…¼å®¹æ€§

æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸¤ä¸ªæ–‡ä»¶ï¼Œè®© APP èƒ½å¤Ÿå®¹å¿ Discuz è¿™ç§â€œéšå¿ƒæ‰€æ¬²â€çš„æ•°æ®æ ¼å¼ã€‚

#### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹ `lib/forum_model.dart` (é˜²çˆ†è§£æ)

æˆ‘ä»¬è¦ç¡®ä¿æ— è®ºæœåŠ¡å™¨ç»™çš„æ˜¯æ•°å­—è¿˜æ˜¯å­—ç¬¦ä¸²ï¼Œè¿˜æ˜¯ç©ºå€¼ï¼Œæ¨¡å‹éƒ½èƒ½å®‰å…¨è½¬æ¢ï¼Œä¸ä¼šæŠ¥é”™ã€‚

è¯·**å®Œå…¨è¦†ç›–** `lib/forum_model.dart`ï¼š

```dart
// lib/forum_model.dart

class Category {
  final String fid;
  final String name;
  final List<String> forumIds;

  Category({required this.fid, required this.name, required this.forumIds});

  factory Category.fromJson(Map<String, dynamic> json) {
    // Discuz çš„ forums å­—æ®µæœ‰æ—¶å€™æ˜¯ Listï¼Œæœ‰æ—¶å€™æ˜¯ null
    List<String> fids = [];
    if (json['forums'] != null && json['forums'] is List) {
      fids = List<String>.from(json['forums']);
    }
    
    return Category(
      fid: json['fid']?.toString() ?? '',
      name: json['name']?.toString() ?? '', // å¼ºåˆ¶è½¬ Stringï¼Œé˜²æ­¢ null
      forumIds: fids,
    );
  }
}

class Forum {
  final String fid;
  final String name;
  final String threads;
  final String posts;
  final String description;
  final String todayposts;

  Forum({
    required this.fid,
    required this.name,
    required this.threads,
    required this.posts,
    required this.description,
    required this.todayposts,
  });

  factory Forum.fromJson(Map<String, dynamic> json) {
    return Forum(
      fid: json['fid']?.toString() ?? '',
      name: json['name']?.toString() ?? '',
      threads: json['threads']?.toString() ?? '0', // å³ä½¿æ˜¯ int ä¹Ÿèƒ½è½¬ string
      posts: json['posts']?.toString() ?? '0',
      description: json['description']?.toString() ?? '',
      todayposts: json['todayposts']?.toString() ?? '0',
    );
  }
}

class Thread {
  final String tid;
  final String subject;
  final String author;
  final String replies;
  final String views;
  final String readperm;

  Thread({
    required this.tid,
    required this.subject,
    required this.author,
    required this.replies,
    required this.views,
    required this.readperm,
  });

  factory Thread.fromJson(Map<String, dynamic> json) {
    return Thread(
      tid: json['tid']?.toString() ?? '',
      subject: json['subject']?.toString() ?? 'æ— æ ‡é¢˜',
      author: json['author']?.toString() ?? 'åŒ¿å',
      replies: json['replies']?.toString() ?? '0',
      views: json['views']?.toString() ?? '0',
      readperm: json['readperm']?.toString() ?? '0',
    );
  }
}

class PostInfo {
  final String pid;
  final String author;
  final String avatarUrl;
  final String time;
  final String contentHtml;

  PostInfo({
    required this.pid,
    required this.author,
    required this.avatarUrl,
    required this.time,
    required this.contentHtml,
  });
}

class BookmarkItem {
  final String tid;
  final String subject;
  final String author;
  final String authorId;
  final int page;
  final String savedTime;
  final bool isNovelMode;

  BookmarkItem({
    required this.tid,
    required this.subject,
    required this.author,
    required this.authorId,
    required this.page,
    required this.savedTime,
    this.isNovelMode = false,
  });

  Map<String, dynamic> toJson() => {
    'tid': tid,
    'subject': subject,
    'author': author,
    'authorId': authorId,
    'page': page,
    'savedTime': savedTime,
    'isNovelMode': isNovelMode,
  };

  factory BookmarkItem.fromJson(Map<String, dynamic> json) {
    return BookmarkItem(
      tid: json['tid'] ?? "",
      subject: json['subject'] ?? "",
      author: json['author'] ?? "",
      authorId: json['authorId'] ?? "",
      page: json['page'] ?? 1,
      savedTime: json['savedTime'] ?? "",
      isNovelMode: json['isNovelMode'] ?? false,
    );
  }
}
```

#### ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ `lib/main.dart` (å¤„ç† JSON ç»“æ„å˜å¼‚)

è¯·åœ¨ `_ForumHomePageState` ç±»ä¸­ï¼Œæ‰¾åˆ° `_parsePageContent` æ–¹æ³•ï¼Œä¿®æ”¹**ä¸­é—´è§£æ `Variables` çš„éƒ¨åˆ†**ã€‚

**é‡ç‚¹ä¿®æ”¹é€»è¾‘ï¼š** æ£€æŸ¥ `catlist` å’Œ `forumlist` åˆ°åº•æ˜¯ List è¿˜æ˜¯ Mapï¼ˆPHP ç»å¸¸æŠŠç©ºæ•°ç»„å˜æˆç©ºå¯¹è±¡ï¼‰ï¼Œå¦‚æœæ˜¯ Map è¿˜æ˜¯ Listï¼Œæˆ‘ä»¬éƒ½æŠŠå®ƒç»Ÿä¸€è½¬æˆ Listã€‚

```dart
      // ... (å‰é¢æ£€æŸ¥ Variables == null çš„ä»£ç ä¸å˜) ...

      var variables = data['Variables'];
      
      // ... (ä¸­é—´æ›´æ–° username / uid / avatar çš„ä»£ç ä¸å˜) ...

      // === ã€æ ¸å¿ƒä¿®å¤ã€‘å…¼å®¹ PHP æ•°ç»„/å¯¹è±¡å˜å¼‚ ===
      
      List<Category> tempCats = [];
      var rawCatList = variables['catlist'];

      // 1. è§£æ catlist (å¯èƒ½æ˜¯ List ä¹Ÿå¯èƒ½æ˜¯ Map)
      if (rawCatList != null) {
        if (rawCatList is List) {
          tempCats = rawCatList.map((e) => Category.fromJson(e)).toList();
        } else if (rawCatList is Map) {
          // å¦‚æœæ˜¯ Map {"0": {...}, "1": {...}}ï¼Œè½¬æˆ List
          rawCatList.forEach((k, v) {
            tempCats.add(Category.fromJson(v));
          });
        }
      }

      // 2. è§£æ forumlist (åŒç†)
      Map<String, Forum> tempForumMap = {};
      var rawForumList = variables['forumlist'];
      
      if (rawForumList != null) {
        if (rawForumList is List) {
          for (var f in rawForumList) {
            var forum = Forum.fromJson(f);
            tempForumMap[forum.fid] = forum;
          }
        } else if (rawForumList is Map) {
          rawForumList.forEach((k, v) {
            var forum = Forum.fromJson(v);
            tempForumMap[forum.fid] = forum;
          });
        }
      }

      print("âœ… è§£ææˆåŠŸ: è·å–åˆ° ${tempCats.length} ä¸ªåˆ†åŒº, ${tempForumMap.length} ä¸ªæ¿å—");

      if (mounted) {
        setState(() {
          _categories = tempCats;
          _forumsMap = tempForumMap;
          _isLoading = false; // å…³æ‰åŠ è½½æ¡
        });
      }
    } catch (e) {
      print("âŒ è§£æè¿‡ç¨‹æŠ¥é”™: $e"); // å¦‚æœè¿˜æœ‰é”™ï¼Œè¿™è¡Œä¼šå‘Šè¯‰æˆ‘ä»¬
      if (mounted) setState(() { _isLoading = false; });
    }
```

### æ€»ç»“

1.  **æ•°æ®åˆ°äº†**ï¼šä½ çš„æ—¥å¿—è¯æ˜ç½‘ç»œå’Œ Cookie éƒ½æ²¡é—®é¢˜äº†ï¼Œè¿™æ˜¯æœ€å¤§çš„èƒœåˆ©ã€‚
2.  **è§£ææŒ‚äº†**ï¼šæ˜¯å› ä¸º Discuz è¿”å›çš„æ•°æ®ç»“æ„ä¸ç¨³å®šï¼ˆæœ‰æ—¶å€™æ˜¯ `[]` æœ‰æ—¶å€™æ˜¯ `{}`ï¼‰ï¼Œä¹‹å‰çš„ä»£ç å¤ªè€å®ï¼Œé‡åˆ°ç±»å‹ä¸å¯¹å°±å´©äº†ã€‚
3.  **ä¿®å¤å**ï¼šæ–°çš„ä»£ç ä¼šæ™ºèƒ½åˆ¤æ–­æ˜¯ List è¿˜æ˜¯ Mapï¼Œå¹¶ä¸”æŠŠæ‰€æœ‰å­—æ®µéƒ½å¼ºåˆ¶è½¬æˆ Stringï¼Œä¸»é¡µåˆ—è¡¨åº”è¯¥å°±èƒ½é¡ºåˆ©æ¸²æŸ“å‡ºæ¥äº†ï¼

å¿«è¯•è¯•å§ï¼Œè¿™æ¬¡ç¦»æˆåŠŸçœŸçš„åªå·®è¿™ä¸€æ­¥è§£æäº†ï¼